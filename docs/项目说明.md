# 《新闻联播》文字稿爬虫项目 - 启动说明

## 项目概述

这是一个自动爬取央视《新闻联播》文字稿的 Node.js 项目。每天自动抓取当日新闻联播内容并生成 Markdown 格式的文字稿,同时提供 Web 页面查看历史记录。

**核心功能:**
- 自动爬取 CCTV 新闻联播官网内容
- 生成 Markdown 格式的文字稿
- 维护历史目录索引
- 提供 Web 界面查看

---

## 快速启动

### 1. 环境要求
- Node.js (支持 ES Module,建议 v14+)
- npm 或 yarn

### 2. 安装依赖
```bash
npm install
```

### 3. 运行爬虫
```bash
npm run index
# 或直接运行
node index.js
```

### 4. 查看结果
- 生成的文字稿位于 `/news/YYYYMMDD.md`
- 打开 `index.html` 查看所有历史记录
- 打开 `web/view.html?date=YYYYMMDD` 查看指定日期

---

## 项目结构与文件说明

### 📁 根目录文件

#### **`package.json`**
**作用:** 项目配置文件
- 定义项目名称为 "xin-wen-lian-bo" (新闻联播)
- 声明依赖: `jsdom` (DOM 解析) 和 `node-fetch` (HTTP 请求)
- 配置 `type: "module"` 启用 ES Module
- 定义启动脚本 `npm run index`

#### **`index.js`** ⭐ 核心主程序
**作用:** 爬虫主逻辑,负责整个数据抓取和处理流程

**核心流程:**
1. **获取新闻列表** (`getNewsList`) - 从 CCTV 官网抓取当日新闻链接
2. **获取新闻摘要** (`getAbstract`) - 提取新闻简介
3. **获取详细新闻** (`getNews`) - 逐条抓取新闻标题和内容
4. **转换为 Markdown** (`newsToMarkdown`) - 格式化为 MD 文档
5. **保存文件** (`saveTextToFile`) - 写入 `/news/YYYYMMDD.md`
6. **更新目录** (`updateCatalogue`) - 更新 `catalogue.json` 和 `README.md`

**关键函数:**
- `getDate()` - 获取当前日期 (格式: 20220929)
- `readFile()` / `writeFile()` - 文件读写封装
- `getNewsList()` - 解析 CCTV 新闻列表页
- `getAbstract()` - 提取新闻摘要
- `getNews()` - 批量抓取新闻详情
- `newsToMarkdown()` - 生成 Markdown 文档
- `updateCatalogue()` - 维护索引文件

#### **`fetch.js`**
**作用:** HTTP 请求封装模块
- 封装 `node-fetch` 库
- 配置请求头模拟浏览器行为 (User-Agent, Referer 等)
- 避免被反爬虫机制拦截
- 返回 HTML 文本内容

#### **`index.html`** 🌐 主页面
**作用:** 项目首页,展示所有新闻目录和摘要
- 读取 `/news/catalogue.json` 获取历史记录
- 使用 `showdown.js` 将 Markdown 渲染为 HTML
- 显示目录列表和新闻摘要
- 提供跳转到详情页的链接

#### **`.gitignore`**
**作用:** Git 版本控制忽略文件
- 忽略 `node_modules` (依赖包)
- 忽略 `serve.json` (本地配置)

#### **`DEVELOP.md`**
**作用:** 开发文档 (当前为空,标记为"待完善")

#### **`LICENSE`**
**作用:** 开源协议文件

---

### 📁 `/news` 目录

**作用:** 存储所有新闻文字稿

#### **`/news/YYYYMMDD.md`**
- 每日生成的新闻联播文字稿
- 包含新闻摘要和详细内容
- Markdown 格式,便于阅读和版本管理

#### **`/news/catalogue.json`**
**作用:** 历史记录索引文件
- JSON 数组格式
- 每条记录包含 `date` (日期) 和 `abstract` (摘要)
- 用于首页快速加载目录

**数据结构:**
```json
[
  {
    "date": "20220929",
    "abstract": "新闻摘要内容..."
  }
]
```

---

### 📁 `/web` 目录

**作用:** Web 前端资源

#### **`view.html`** 🌐 详情页
**作用:** 查看指定日期的新闻文字稿
- 通过 URL 参数 `?date=YYYYMMDD` 指定日期
- 动态加载 `/news/YYYYMMDD.md` 文件
- 使用 `showdown.js` 渲染 Markdown
- 加载失败时显示 `Error.md`

#### **`Error.md`**
**作用:** 404 错误提示页面
- 当访问不存在的日期时显示
- 说明可能的错误原因

#### **`github-markdown.min.css`**
**作用:** GitHub 风格的 Markdown 样式表
- 提供美观的文档渲染效果

#### **`showdown.min.js`**
**作用:** Markdown 转 HTML 的 JavaScript 库
- 前端实时渲染 Markdown 内容

---

## 工作流程图

```
用户运行 node index.js
    ↓
获取当前日期 (如: 20220929)
    ↓
访问 CCTV 官网获取新闻列表
    ↓
提取摘要链接和新闻链接数组
    ↓
抓取新闻摘要内容
    ↓
逐条抓取所有新闻详情 (标题+内容)
    ↓
转换为 Markdown 格式
    ↓
保存到 /news/20220929.md
    ↓
更新 /news/catalogue.json (追加新记录)
    ↓
更新 README.md (插入新链接)
    ↓
完成 ✓
```

---

## 数据来源

**目标网站:** CCTV 新闻联播官网
- 列表页: `http://tv.cctv.com/lm/xwlb/day/YYYYMMDD.shtml`
- 详情页: 从列表页解析的各新闻链接

**爬取策略:**
- 使用 `jsdom` 解析 HTML DOM
- 通过 CSS 选择器定位元素
- 模拟浏览器请求头避免拦截

---

## 注意事项

### ⚠️ 运行时机
- 建议每天 **20:30 之后** 运行,确保新闻联播已播出且官网已更新
- 过早运行会导致抓取失败

### ⚠️ 网络依赖
- 需要稳定的网络连接访问 CCTV 官网
- 请求失败时会抛出异常

### ⚠️ 反爬虫
- 已配置请求头模拟浏览器
- 如遇拦截,可能需要更新 `fetch.js` 中的 headers

### ⚠️ 选择器失效
- 如果 CCTV 官网改版,CSS 选择器可能失效
- 需要更新 `index.js` 中的选择器路径

---

## 自动化部署建议

### 使用 Cron 定时任务 (Linux/Mac)
```bash
# 每天 20:30 自动运行
30 20 * * * cd /path/to/project && node index.js
```

### 使用 GitHub Actions
```yaml
name: Daily News Fetch
on:
  schedule:
    - cron: '30 12 * * *'  # UTC 12:30 = 北京时间 20:30
jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: node index.js
      - run: git add . && git commit -m "Update news" && git push
```

---

## 技术栈

- **运行环境:** Node.js (ES Module)
- **HTTP 请求:** node-fetch
- **HTML 解析:** jsdom
- **前端渲染:** showdown.js (Markdown → HTML)
- **样式:** github-markdown.css

---

## 开发建议

### 代码质量评估 🟡 可接受

**优点:**
- 逻辑清晰,流程简单直接
- 函数职责单一
- 使用 Promise 处理异步

**改进空间:**
1. **硬编码的 CSS 选择器** - 应提取为配置文件
2. **错误处理不足** - 缺少 try-catch 和重试机制
3. **并发抓取** - 可使用 `Promise.all` 提升速度
4. **日志系统** - 应使用专业日志库 (如 winston)
5. **配置管理** - 应分离配置和代码

### 建议重构方向

```javascript
// 配置文件 config.js
export default {
  selectors: {
    abstract: '#page_body > div.allcontent > ...',
    title: '#page_body > div.allcontent > ...',
    content: '#content_area'
  },
  retry: 3,
  timeout: 5000
}

// 错误处理
const getNewsWithRetry = async (url, retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      return await getNews(url);
    } catch (e) {
      if (i === retries - 1) throw e;
      await sleep(1000 * (i + 1));
    }
  }
}
```

---

## 常见问题

**Q: 为什么抓取失败?**
A: 检查网络连接、运行时间 (是否过早)、CCTV 官网是否改版

**Q: 如何查看历史记录?**
A: 打开 `index.html` 或访问 `web/view.html?date=YYYYMMDD`

**Q: 可以抓取历史数据吗?**
A: 可以修改 `DATE` 变量为指定日期,但需注意 CCTV 官网的历史数据可用性

**Q: 如何部署到服务器?**
A: 配置 Cron 定时任务或使用 GitHub Actions 自动化

---

## 总结

这是一个 **简单实用** 的新闻爬虫项目,核心代码不到 200 行,但功能完整。

**适合场景:**
- 个人学习爬虫技术
- 自动化新闻归档
- 数据分析研究

**核心价值:**
- 代码简洁,易于理解和修改
- 无数据库依赖,纯文件存储
- 前端展示友好

**改进建议:**
- 增强错误处理和日志
- 提取配置,降低维护成本
- 优化并发性能
- 添加单元测试

---

&copy; 2024 项目说明文档 | 基于源代码分析生成
